// ==UserScript==
// @name         Crunchy/MAL linker
// @namespace    https://github.com/roddolf/scripts
// @version      1.4.0
// @description  Add links into Crunchyroll for MAL anime library.
// @author       Rodolfo Aguirre
// @include      /^https?:\/\/www.crunchyroll.com\/([a-z-]+/)?[a-zA-Z-\d]+$/
// @include      /^https?:\/\/beta.crunchyroll.com/
// @updateURL    https://raw.githubusercontent.com/roddolf/crunchyroll-mal-linker/master/script.meta.js
// @downloadURL  https://raw.githubusercontent.com/roddolf/crunchyroll-mal-linker/master/dist/script.user.js
// @connect      api.jikan.moe
// @connect      api.myanimelist.net
// @grant        GM.xmlHttpRequest
// ==/UserScript==
!function(){"use strict";const e=(e,t)=>(async(e,t,n)=>{const a=await GM.xmlHttpRequest({method:e,url:t,fetch:!0,headers:n});return 200!==a.status?Promise.reject(a):JSON.parse(a.responseText)})(e,`https://api.myanimelist.net/v2/${t}`,{"X-MAL-CLIENT-ID":"96884d8bfed54d526cc619941f4398af"}),t=async t=>{const n=`anime/${t}?fields=alternative_titles,related_anime{alternative_titles}`,a=await e("GET",n);if(a)return a},n=async(e,t)=>{if(!(null==e?void 0:e.length))return[];let n=e.filter((e=>{var n,a;return e.node.title===t||(null===(a=null===(n=e.node.alternative_titles)||void 0===n?void 0:n.synonyms)||void 0===a?void 0:a.find((e=>e===t)))}));return 1===n.length?n:(n=e.filter((e=>{var n;return(null===(n=e.node.alternative_titles)||void 0===n?void 0:n.en)===t})),1===n.length?n:void 0)},a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABSlBMVEUAAAAuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaIuUaI1VqU8Xag5W6cyVKQ1V6U3WaaQo87////6+/1YdLV5j8NrhL2InMrH0eby9Pm5xOC1wt7g5fE4WaZKaK709fqEmcjw8/gwU6OvvNvS2euquNleebh0jMGcrNOks9fo7PW3w9+hsdWdrtRferjx8/l9k8X9/f5ge7j+/v/v8fhzisEwUqN2jcKjs9bL0+jz9fpPbLHO1un4+vz3+PuKncva4O+ot9iBlseNoMyCl8e9yOE0VqXX3u20wd6sutpMaq/e5PC9yOJ1jML4+fxUcLPN1enFz+XBy+OvvdyisdXQ2Or19/vj6PNrg706W6f7/P2FmcnK0+fV3Oy4xN/h5vIvUqKuu9uaq9J+lMZLaa/8/P7d4vBbd7apt9n+PssoAAAAD3RSTlMBFYfT+dGDU/EX81X79c+4RnuEAAAAAWJLR0QXC9aYjwAAAAd0SU1FB+QKHwgGD8s9R/MAAAGYSURBVEjH7dZXV8IwFADgsIfjMsS4UGSIAxeIC/fGvReKWvf6/6/eJrVQT1uaB1883ock9+R+tE1PSQghxGZ3OKFmOF1uG2Hh8dau5uH1sHqr5XKgsFn+fXYNH3GL1APYiUsMOIiF9dGsFRGrB/gHvwUCwWAwpKQ4DIYrsyFMmwAi2EUqoJlS2tLKsjYc0nbFdkQ75bQLIIZdTAtodxyTRLICUqwaoyetC2gvQLiPfoN0P1VjQB/QDAxSFQyx0fDIaDabzRmAsfy4CiYmsZ+aLsxEo9FZMABqIJjDbn6BTy3qgiVeu8xBQr7ACpiB1TUG1jlIyd1GsVjcNAZb29juAAe71XdoAGAvSffjCjiwAuDw6BgUcGIJANZXgdOi+TMoKQdn2J6D+SppwAW2lz9A6UqOa32Qkd9MWQtY3JT1QbyE3a0OuGO3lJck6V4BOJRywF7EwyOfegJ4lpR4MfpEX9/o+4fQN/2ZDYAQKJj9CYjFnwCCW5ZfdFN0iW+7PtGNXfjoQEid3/ITe/hxBo8/9bWrGxrZ8ecLzYqyUsKHVC0AAAAldEVYdGRhdGU6Y3JlYXRlADIwMjAtMTAtMzFUMDg6MDY6MTMrMDA6MDA+Vi6IAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIwLTEwLTMxVDA4OjA2OjEzKzAwOjAwTwuWNAAAAABJRU5ErkJggg==",i=async a=>{var i;const A=`anime?q=${encodeURI(a)}&limit=25&fields=alternative_titles`,l=await e("GET",A);if(!(null===(i=null==l?void 0:l.data)||void 0===i?void 0:i.length))return;let o=await n(l.data,a);if(!(null==o?void 0:o.length)){const e=await t(l.data[0].node.id);o=await n(null==e?void 0:e.related_anime,a)}const s=(null==o?void 0:o.length)?o[0]:l.data[0];return`https://myanimelist.net/anime/${s.node.id}/${s.node.title}`},A=async()=>{const e=await(async e=>{const t=document.querySelector(e);return t||await new Promise((t=>{const n=new MutationObserver((()=>{const a=document.querySelector(e);a&&(n.disconnect(),t(a))}));n.observe(document.documentElement,{childList:!0,subtree:!0})}))})(".erc-series-hero > .body .title");await(async e=>{var t,n;if(null===(t=e.parentElement)||void 0===t?void 0:t.querySelector("a"))return;const A=e.textContent;if(!A)return;const l=await i(A);if(!l)return;const o=document.createElement("a");o.href=l,o.target="_blank",o.style.display="inline-block",o.style.fontSize="0",o.style.marginLeft="1.875rem";const s=document.createElement("img");s.src=a,s.style.width="inherit",o.appendChild(s),null===(n=e.parentElement)||void 0===n||n.insertBefore(o,e.nextElementSibling)})(e)};location.hostname.startsWith("beta.")?window.onload=function(){A(),(()=>{let e=document.location.href;new MutationObserver((()=>{e!=document.location.href&&(e=document.location.href,e.match(/series\/[a-zA-Z-\d]+\/[a-zA-Z-\d]+$/)&&A())})).observe(document.documentElement,{childList:!0,subtree:!0})})()}:$((async()=>{if(!$("#source_showview").length)return;const e=$("h1.ellipsis"),t=$("h1.ellipsis span").text(),n=await i(t);n&&e.append(`<a href="${n}" style="vertical-align: middle;"><img src="${a}" style='width: 17px; border: 0'></a>`)}))}();
